
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>My</title>
   
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const brokerUrl = 'wss://damoa.io:9002';
    
        // 고유한 클라이언트 ID 생성 (다른 사용자와 충돌 방지)
        const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);
        
        // 별도 인증이 필요 없으므로 options 객체는 간단하게 clientId만 포함
        const options = {
          clientId: clientId,
        };
    
        console.log(`MQTT 브로커(${brokerUrl})에 접속을 시도합니다...`);
        const client = mqtt.connect(brokerUrl, options);
    
        // 1. 브로커 접속 성공 시 실행되는 이벤트
        client.on('message', (topic, message) => {
          const s = message.toString();
          const mainDiv = document.getElementById('main');
          const now = new Date().toLocaleTimeString();

          // JSON이면 파싱해서 온도/습도 표시
          let line = '';
          try {
            const obj = JSON.parse(s);
            const t = obj.temperature ?? obj.temp ?? obj.T;
            const h = obj.humidity ?? obj.hum ?? obj.H;
            if (t !== undefined || h !== undefined) {
              line = `📥 <b>${topic}</b> <small>${now}</small> — T: ${t}℃, H: ${h}%`;
            } else {
              line = `📥 <b>${topic}</b> <small>${now}</small> — ${s}`;
            }
          } catch(_) {
            // 일반 텍스트
            line = `📥 <b>${topic}</b> <small>${now}</small> — ${s}`;
          }
        
          // 새 줄을 “추가”
          const div = document.createElement('div');
          div.className = 'message-item';
          div.innerHTML = line;
          mainDiv.appendChild(div);
        
          // 최신 메시지 보이게 스크롤
          mainDiv.scrollTop = mainDiv.scrollHeight;
        
          // (선택) 너무 많아지면 앞에서 제거
          if (mainDiv.children.length > 200) mainDiv.removeChild(mainDiv.firstChild);
        });

    </script>
</head>
    
<body>
  <h3>나의 웹(2270006, 고지희)</h3>
  <div id="status">연결 준비…</div>
  <div id="main"></div>
</body>
</html>
