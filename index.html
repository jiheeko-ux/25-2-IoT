<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>My</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    #main { margin-top: 10px; max-height: 60vh; overflow-y: auto; border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    .message-item { padding: 6px 8px; border-bottom: 1px dashed #eee; }
    .message-item:last-child { border-bottom: 0; }
    small { opacity: .65; }
  </style>
</head>
<body>
  <h3>ë‚˜ì˜ ì›¹(2270006, ê³ ì§€í¬)</h3>
  <div id="status">ì—°ê²° ì¤€ë¹„â€¦</div>
  <div id="main"></div>

  <script>
    const brokerUrl = 'wss://damoa.io:9002';
    const topic = 'ewha/2270006';

    const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);
    const client = mqtt.connect(brokerUrl, { clientId });

    const $status = document.getElementById('status');
    const $main = document.getElementById('main');

    client.on('connect', () => {
      console.log(`âœ… ì ‘ì† ì„±ê³µ! (í´ë¼ì´ì–¸íŠ¸ ID: ${clientId})`);
      $status.textContent = `âœ… ì—°ê²°ë¨ â†’ êµ¬ë…: ${topic}`;
      client.subscribe(topic, (err) => {
        if (!err) {
          console.log(`ğŸ“„ í† í”½ êµ¬ë… ì„±ê³µ: ${topic}`);
          client.publish('ewha/checkin', '2270006 ê³ ì§€í¬');
        } else {
          console.error('í† í”½ êµ¬ë… ì˜¤ë¥˜:', err);
          $status.textContent = 'êµ¬ë… ì‹¤íŒ¨: ' + err.message;
        }
      });
    });

    client.on('message', (t, payload) => {
      const s = payload.toString();
      const now = new Date().toLocaleTimeString();
      let line;

      // JSONì´ë©´ ì˜¨ìŠµë„ ì˜ˆì˜ê²Œ
      try {
        const obj = JSON.parse(s);
        const tt = obj.temperature ?? obj.temp ?? obj.T;
        const hh = obj.humidity ?? obj.hum ?? obj.H;
        if (tt !== undefined || hh !== undefined) {
          line = `ğŸ“¥ <b>${t}</b> <small>${now}</small> â€” T: ${tt}â„ƒ, H: ${hh}%`;
        } else {
          line = `ğŸ“¥ <b>${t}</b> <small>${now}</small> â€” ${s}`;
        }
      } catch {
        line = `ğŸ“¥ <b>${t}</b> <small>${now}</small> â€” ${s}`;
      }

      const div = document.createElement('div');
      div.className = 'message-item';
      div.innerHTML = line;
      $main.appendChild(div);
      $main.scrollTop = $main.scrollHeight;

      // 200ê°œ ë„˜ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒë¶€í„° ì œê±°(ì„ íƒ)
      if ($main.children.length > 200) $main.removeChild($main.firstChild);
    });

    client.on('reconnect', () => { $status.textContent = 'ì¬ì—°ê²° ì‹œë„ ì¤‘â€¦'; });
    client.on('close',     () => { $status.textContent = 'ì—°ê²° ì¢…ë£Œ'; });
    client.on('error', (err) => {
      console.error('ì—°ê²° ì˜¤ë¥˜:', err);
      $status.textContent = 'ì—°ê²° ì˜¤ë¥˜: ' + err.message;
      client.end();
    });
  </script>
</body>
</html>

