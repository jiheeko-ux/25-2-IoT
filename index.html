<!-- í”„ë¡œê·¸ë¨ ì œëª©: MQTT ì›¹ í´ë¼ì´ì–¸íŠ¸ (ê³ ì§€í¬ 2270006) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>My</title>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const brokerUrl = 'wss://damoa.io:9002';

    // ê³ ìœ í•œ í´ë¼ì´ì–¸íŠ¸ ID ìƒì„± (ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ì¶©ëŒ ë°©ì§€)
    const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);

    // ë³„ë„ ì¸ì¦ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ options ê°ì²´ëŠ” ê°„ë‹¨í•˜ê²Œ clientIdë§Œ í¬í•¨
    const options = {
      clientId: clientId,
    };

    console.log(`MQTT ë¸Œë¡œì»¤(${brokerUrl})ì— ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤...`);
    const client = mqtt.connect(brokerUrl, options);

    // 1. ë¸Œë¡œì»¤ ì ‘ì† ì„±ê³µ ì‹œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
    client.on('connect', () => {
      console.log(`âœ… ì ‘ì† ì„±ê³µ! (í´ë¼ì´ì–¸íŠ¸ ID: ${clientId})`);

      // 2. ì ‘ì† ì„±ê³µ í›„ í† í”½ êµ¬ë…
      const topic = 'ewha/2270006';  // 
      client.subscribe(topic, (err) => {
        if (!err) {
          console.log(`ğŸ“„ í† í”½ êµ¬ë… ì„±ê³µ: ${topic}`);

          // 3. êµ¬ë… ì„±ê³µ í›„ ì²´í¬ì¸ìš© ë©”ì‹œì§€ ë°œí–‰
          client.publish('ewha/checkin', '2270006 ê³ ì§€í¬'); // âœ… ë„¤ í•™ë²ˆ + ì´ë¦„
        } else {
          console.error('í† í”½ êµ¬ë… ì˜¤ë¥˜:', err);
        }
      });
    });

    // 4. êµ¬ë…í•œ í† í”½ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë“¤ì–´ì™”ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸
    client.on('message', (topic, message) => {
      console.log(`${topic} ${message.toString()}`);

      const mainDiv = document.getElementById('main');

      const messageHTML = `
        <div class="message-item">
          <span>${message.toString()}</span>
        </div>
      `;

      // ìµœì‹  ë©”ì‹œì§€ë§Œ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ (ì´ì „ ë©”ì‹œì§€ëŠ” ë®ì–´ì”€)
      mainDiv.innerHTML = messageHTML;

      // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ì•„ë˜ë¡œ ì´ë™ì‹œì¼œ ìµœì‹  ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤Œ
      mainDiv.scrollTop = mainDiv.scrollHeight;
    });

    // ì ‘ì† ì¤‘ ì—ëŸ¬ ë°œìƒ ì‹œ
    client.on('error', (err) => {
      console.error('ì—°ê²° ì˜¤ë¥˜:', err);
      client.end();
    });
  </script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    #main {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-height: 60px;
    }
    .message-item { padding: 4px 0; }
  </style>
</head>

<body>
  <h3>ë‚˜ì˜ ì›¹(2270006, ê³ ì§€í¬)</h3>  <!-- âœ… ì—¬ê¸°ì—ë„ ë„¤ ì •ë³´ -->
  <div id="main">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
</body>
</html>
