<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>My</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    #main { margin-top: 10px; max-height: 60vh; overflow-y: auto; border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    .message-item { padding: 6px 8px; border-bottom: 1px dashed #eee; }
    .message-item:last-child { border-bottom: 0; }
    small { opacity: .65; }
  </style>
</head>
<body>
  <h3>나의 웹(2270006, 고지희)</h3>
  <div id="status">연결 준비…</div>
  <div id="main"></div>

  <script>
    const brokerUrl = 'wss://damoa.io:9002';
    const topic = 'ewha/2270006';

    const clientId = 'iot-client-' + Math.random().toString(16).substr(2, 8);
    const client = mqtt.connect(brokerUrl, { clientId });

    const $status = document.getElementById('status');
    const $main = document.getElementById('main');

    client.on('connect', () => {
      console.log(`✅ 접속 성공! (클라이언트 ID: ${clientId})`);
      $status.textContent = `✅ 연결됨 → 구독: ${topic}`;
      client.subscribe(topic, (err) => {
        if (!err) {
          console.log(`📄 토픽 구독 성공: ${topic}`);
          client.publish('ewha/checkin', '2270006 고지희');
        } else {
          console.error('토픽 구독 오류:', err);
          $status.textContent = '구독 실패: ' + err.message;
        }
      });
    });

    client.on('message', (t, payload) => {
      const s = payload.toString();
      const now = new Date().toLocaleTimeString();
      let line;

      // JSON이면 온습도 예쁘게
      try {
        const obj = JSON.parse(s);
        const tt = obj.temperature ?? obj.temp ?? obj.T;
        const hh = obj.humidity ?? obj.hum ?? obj.H;
        if (tt !== undefined || hh !== undefined) {
          line = `📥 <b>${t}</b> <small>${now}</small> — T: ${tt}℃, H: ${hh}%`;
        } else {
          line = `📥 <b>${t}</b> <small>${now}</small> — ${s}`;
        }
      } catch {
        line = `📥 <b>${t}</b> <small>${now}</small> — ${s}`;
      }

      const div = document.createElement('div');
      div.className = 'message-item';
      div.innerHTML = line;
      $main.appendChild(div);
      $main.scrollTop = $main.scrollHeight;

      // 200개 넘으면 오래된 것부터 제거(선택)
      if ($main.children.length > 200) $main.removeChild($main.firstChild);
    });

    client.on('reconnect', () => { $status.textContent = '재연결 시도 중…'; });
    client.on('close',     () => { $status.textContent = '연결 종료'; });
    client.on('error', (err) => {
      console.error('연결 오류:', err);
      $status.textContent = '연결 오류: ' + err.message;
      client.end();
    });
  </script>
</body>
</html>

